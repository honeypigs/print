(window.webpackJsonp=window.webpackJsonp||[]).push([["bundle_resetLocation"],{1660:function(e,t,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var o=f(a(16)),r=f(a(0)),n=f(a(1)),l=f(a(7)),i=a(21),s=a(113),c=a(51),d=f(a(100)),u=a(244),h=a(82),v=a(143);function f(e){return e&&e.__esModule?e:{default:e}}var p=window,g=function(){function e(t,a){var o=this;(0,r.default)(this,e),this.updateParamAsLocation=function(){var e=o.app.view,t=e.getSheetLocation(),a=e.getCurrentPosition(),r=a.rowIndex,n=a.colIndex,l=o.app.spreadsheet.getActiveSheetId();o.handleChangeWithLoc({selectRange:t,sheetId:l,rowIndex:r,colIndex:n})},this.app=t,this.options=a||null}return(0,n.default)(e,[{key:"initEvent",value:function(){var e=function(){l.default.event.default.trigger("updateParamAsServer")},t=function(){l.default.event.default.trigger("updateParamAsLocation")};l.default.event.view.listen(h.EVENT_NAME.SELECTION_CHANGE,(0,s.throttle)(t,1e3,this,!1)),l.default.event.default.listen("tableMove",(0,s.throttle)(t,1e3,this,!1)),l.default.event.view.listen(h.EVENT_NAME.SELECTION_CHANGE,(0,s.throttle)(e,1e3,this,!1)),l.default.event.default.listen("tableMove",(0,s.throttle)(e,1e3,this,!1)),l.default.event.default.listen("updateParamAsLocation",(0,s.throttle)(this.updateParamAsLocation,1e3,this,!1)),l.default.event.default.listen("updateParamAsServer",(0,s.throttle)(this.updateParamAsServer,12e4,this,!1))}},{key:"updateParamAsServer",value:function(){var e=this.app.view,t=e.getSheetLocation(),a=e.getCurrentPosition(),o=a.rowIndex,r=a.colIndex,n=this.app.spreadsheet.getActiveSheetId();this.handleChangeWithServer({selectRange:t,sheetId:n,rowIndex:o,colIndex:r})}},{key:"handleChangeWithLoc",value:function(e){var t=e.selectRange,a=e.sheetId,o=e.rowIndex,r=e.colIndex,n=(new Date).getTime(),l=this.encodeLocation(!1,t,o,r);this.saveAsUrl(l),this.setShortLink(l);var i=this.encodeLocation(!0,t,o,r);this.saveAsStorage(i,a,n)}},{key:"handleChangeWithServer",value:function(e){var t=e.selectRange,a=e.sheetId,o=e.rowIndex,r=e.colIndex,n=(new Date).getTime(),l=this.encodeLocation(!1,t,o,r);this.saveAsServer(l,a,n)}},{key:"saveAsUrl",value:function(e){var t=p.location.hash,a=this.replaceParam(p.location.href,"c",e);t&&(a+=t),p.history.replaceState(e,"",a)}},{key:"setShortLink",value:function(e){if(l.default.clientVars){var t=(0,v.getQuery)("tab")||this.app.spreadsheet.getFirstSheet().getSheetId(),a=l.default.clientVars.shortLink,o=a.split("?")[0],r=this.replaceParam(a,"tab",t);l.default.clientVars.shortLink=o+r}l.default.window.CoreSheet.shareController.setShareInfo()}},{key:"replaceParam",value:function(e,t,a){var o=e.split("?")[1],r="";if(o){var n=o.split("&");n=n.filter(function(e){return e.indexOf(t+"=")<0&&e.indexOf("#")<0}),r=o.length?"?"+n.join("&")+"&"+t+"="+a:"?"+t+"="+a}else r="?"+t+"="+a;return r}},{key:"removeURLParameter",value:function(e,t){var a=e.split("?");if(a.length>=2){for(var o=encodeURIComponent(t)+"=",r=a[1].split(/[&;]/g),n=r.length;n-- >0;)-1!==r[n].lastIndexOf(o,0)&&r.splice(n,1);return a[0]+(r.length>0?"?"+r.join("&"):"")}return e}},{key:"saveAsStorage",value:function(e,t,a){var o=p.clientVars.globalPadId,r=p.clientVars.userInfo;if(localStorage&&r&&o&&t)try{localStorage.setItem("user_"+r.uid+"_"+o+"_"+t,e+"_"+a),localStorage.setItem("user_"+r.uid+"_"+o+"_activeSheet",t+"_"+a)}catch(n){console.error(n)}}},{key:"getStorage",value:function(e){var t=void 0,a=p.clientVars.globalPadId,o=p.clientVars.userInfo;if(localStorage)try{t=localStorage.getItem("user_"+o.uid+"_"+a+"_"+e)}catch(r){console.error(r)}return t}},{key:"getActiveSheetIdFromStorage",value:function(){var e=void 0,t=p.clientVars.globalPadId,a=p.clientVars.userInfo;if(localStorage)try{e=localStorage.getItem("user_"+a.uid+"_"+t+"_activeSheet")}catch(o){console.error(o)}return e}},{key:"getUrlParam",value:function(){var e=(0,v.getQuery)("c")||(0,v.getQuery)("coord"),t=(0,v.getQuery)("tab");if(e&&t)return{coord:e,sheetId:t}}},{key:"saveAsServer",value:function(e,t,a){var r=p.clientVars.globalPadId;return(0,d.default)({url:"/sdc/updatebrowselocation",method:"POST",responseType:"json",headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:"padid="+r+"&location="+(0,o.default)({updateTime:a,coord:e,sheetId:t,isopen:1})+"&xsrf="+l.default.getXsrf()}).then(function(e){console.log(e)})}},{key:"getServer",value:function(){var e="/sdc/getbrowselocation?padid="+p.clientVars.globalPadId+"&xsrf="+l.default.getXsrf();return d.default.get(e)}},{key:"uncodeLocation",value:function(e,t){var a={xRange:[0,0],yRange:[0,0],row:{frozen:0,flow:0},col:{frozen:0,flow:0}},o=0,r=0;if(t){var n=void 0;try{n=decodeURIComponent((0,u.escapeHTML)(t))}catch(g){n=(0,u.escapeHTML)(t)}if(n.indexOf("$")>-1){var l=n.split("$"),i=(0,c.toRC)(l[0]),s=(0,c.toRC)(l[1]);l&&l.length>=6&&i&&s&&(a.xRange=[i.col,s.col],a.yRange=[i.row,s.row],a.col.flow=e?Number(l[2]):0,a.col.frozen=Number(l[3]),a.row.flow=e?Number(l[4]):0,a.row.frozen=Number(l[5]),e||(r=Number(l[2]),o=Number(l[4])))}else{var d=n.match(/([A-Z]+[0-9]+)/gi);if(d&&3===d.length){var h=(0,c.toRC)(d[0]),v=(0,c.toRC)(d[0]),f=(0,c.toRC)(d[1]),p=(0,c.toRC)(d[2]);h&&v&&f&&p&&(a.xRange=[h.col,v.col],a.yRange=[h.row,v.row],a.col.flow=e?f.col:0,a.col.frozen=f.row+1,a.row.flow=e?p.col:0,a.row.frozen=p.row+1,e||(r=f.col,o=p.col))}}}return{selectRange:a,rowIndex:o,colIndex:r}}},{key:"encodeLocation",value:function(e,t,a,o){var r=t.xRange,n=t.yRange,l=t.col,s=t.row,c="";return c+=(0,i.colIndexToName)(r[0]||0)+((n[0]||0)+1),c+=e?(0,i.colIndexToName)(l.flow):(0,i.colIndexToName)(o),c+=l.frozen||0,c+=e?(0,i.colIndexToName)(s.flow):(0,i.colIndexToName)(a),c+=s.frozen||0,c=encodeURIComponent(c)}},{key:"reset",value:function(e,t){var a=this;this.applyStorageData();var o=this.getUrlParam();this.getServer().then(function(r){if(200===r.status){var n=r.data;if(n){var l=n.result;0===n.retcode&&l&&(l.sheetId&&!o?a.applyServerData(e,l,t):a.applyUrlData(e,t))}}}).catch(function(){a.applyUrlData(e,t)})}},{key:"applyUrlData",value:function(e,t){var a=this.getUrlParam(),o=(0,v.getQuery)("tab");if(a){var r=a.coord,n=this.uncodeLocation(!1,r),l=n.selectRange,i=n.rowIndex,s=n.colIndex;o&&o===e?(this.app.handleData.saveSheetSelection(o,l),t("server",o,i,s)):t("local",o)}else t("local",o)}},{key:"applyServerData",value:function(e,t,a){t||a("local",e);var o=e||this.app.spreadsheet.getActiveSheetId(),r=t.coord,n=t.sheetId,l=t.updateTime,i=this.uncodeLocation(!1,r),s=i.selectRange,c=i.rowIndex,d=i.colIndex,u=this.getActiveSheetIdFromStorage();if(u){var h=u.split("_"),v=h[0];l<+h[1]&&(n=v)}if(o!=n)this.applyUrlData(e,a);else{var f=this.app.handleData.getSheetSelection(n);f&&f.updateTime?l>f.updateTime?(this.app.handleData.saveSheetSelection(n,s),a("server",n,c,d)):a("local",n):(this.app.handleData.saveSheetSelection(n,s),a("server",n,c,d))}}},{key:"applyStorageData",value:function(){for(var e=this.app.handleData.getHeader(),t=0;t<e.length;t++){var a=e[t].id,o=this.getStorage(a);if(o){var r=o.split("_"),n=r[0],l=r[1],i=this.uncodeLocation(!0,n).selectRange;i.updateTime=+l,this.app.handleData.saveSheetSelection(a,i)}}}}]),e}();t.default=g}}]);
//# sourceMappingURL=bundle_resetLocation-ee4de850dc.js.map